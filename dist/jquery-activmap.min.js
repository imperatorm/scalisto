!function($){$.activmap={defaults:{places:[],lat:51.5286416,lng:-.1015987,zoom:6,maxZoom:12,cluster:!0,mapType:"roadmap",posPanel:"left",showPanel:!0,radius:0,country:null,autogeolocate:!1,icon:"images/icons/marker-hotel.png",styles:[{featureType:"landscape.man_made",elementType:"geometry",stylers:[{color:"#f7f1df"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#d0e3b4"}]},{featureType:"landscape.natural.terrain",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.medical",elementType:"geometry",stylers:[{color:"#fbd3da"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#bde6ab"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffe15f"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#efd151"}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry.fill",stylers:[{color:"black"}]},{featureType:"transit.station.airport",elementType:"geometry.fill",stylers:[{color:"#cfb2db"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#a2daf2"}]}],request:"large",locationTypes:["geocode","establishment"]}},$.arrayIntersect=function(e,a){return $.grep(e,function(e){return-1<$.inArray(e,a)})},$.fn.extend({activmap:function(settings){var s=$.extend({},$.activmap.defaults,settings),init_latlng=new google.maps.LatLng(s.lat,s.lng),latlng=init_latlng,opendInfoWindow=null,markers=[],infoWindow=[],ids=[],markerCluster,bounds,num_places=0,old_results=0,mapTypeId=google.maps.MapTypeId.ROADMAP;"satellite"!=s.mapType&&"perspective"!=s.mapType||(mapTypeId=google.maps.MapTypeId.HYBRID);var map=new google.maps.Map(document.getElementById("activmap-canvas"),{zoom:s.zoom,maxZoom:s.maxZoom,center:latlng,mapTypeId:mapTypeId,mapTypeControl:!1,streetViewControl:!1,styles:s.styles});"perspective"==s.mapType&&map.setTilt(45);var activmap_canvas=$("#activmap-canvas"),activmap_places=$("#activmap-places"),map_w=activmap_canvas.width(),cont_w=activmap_places.outerWidth();s.showPanel?("left"==s.posPanel&&(activmap_places.css({left:-cont_w,right:"auto"}),activmap_canvas.css({float:"right"})),"right"==s.posPanel&&(activmap_places.css({right:-cont_w,left:"auto"}),activmap_canvas.css({float:"left"}))):activmap_places.hide(),$('input[name="activmap_radius"]').length&&$('input[name="activmap_radius"]').prop("checked",!1).each(function(){s.radius==$(this).val()&&$(this).prop("checked",!0)}),_sort_by_dist=function(e,a){return e.dist<a.dist?-1:e.dist>a.dist?1:0},_order=function(){$.each(s.places,function(e,a){a.dist=_get_distance(a.marker.position,latlng)}),$(".activmap-place").remove(),$.each(s.places,function(e,a){activmap_places.append(a.html),a.isVisible&&$("#activmap-place_"+a.id).show()})},_init=function(){function e(e){initialLocation=(1==e?console.log("Geolocation service failed."):console.log("Your browser doesn't support geolocation."),latlng),map.setCenter(initialLocation)}if($.each(s.places,function(e,t){t.num_tags=0,t.id=e;var a,n=new google.maps.LatLng(t.lat,t.lng),o=""!=t.icon&&null!=t.icon?t.icon:s.icon,i=new google.maps.Marker({map:map,position:n,icon:o,title:t.title});a=null!=t.img&&""!=t.img?'<div class="activmap-brand"><img src="'+t.img+'"></div><h4 class="activmap-title">'+t.title+"</h4>":'<h4 class="activmap-title">'+t.title+"</h4>",null!=t.address&&""!=t.address&&(a+=t.address+"<br>"),null!=t.phone&&""!=t.phone&&(a+=t.phone+"<br>"),null!=t.url&&""!=t.url&&(a+='<a href="'+t.url+'" target="_blank">'+t.url+"</a><br>"),null!=t.custom_content&&""!=t.custom_content&&(a+=t.custom_content+"<br />"),infoWindow[e]=new google.maps.InfoWindow({content:a,position:n}),google.maps.event.addListener(i,"click",function(){null!=opendInfoWindow&&opendInfoWindow.close(),infoWindow[e].open(map,i),opendInfoWindow=infoWindow[e],$(".activmap-place").removeClass("active"),$("#activmap-place_"+e).addClass("active"),activmap_places.scrollTop(activmap_places.scrollTop()+$("#activmap-place_"+e).position().top)}),i.setVisible(!1),t.marker=i,markers.push(i),t.html='<div class="activmap-place" id="activmap-place_'+e+'"><h3>'+t.title+"</h3><p>"+t.address+"</p></div>",$.each(t.tags,function(e,a){void 0===ids[a]&&(ids[a]=[]),ids[a].push(t.id)})}),s.cluster&&(markerCluster=new MarkerClusterer(map,markers,{maxZoom:12,gridSize:40})),_order(),_geolocate=function(){navigator.geolocation?(browserSupportFlag=!0,navigator.geolocation.getCurrentPosition(function(e){initialLocation=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),latlng=initialLocation,_order(),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this))}),_update_map(),map.setCenter(initialLocation)},function(){e(browserSupportFlag)})):(browserSupportFlag=!1,e(browserSupportFlag))},1==s.autogeolocate&&_geolocate(),$("#activmap-geolocate").length&&$("#activmap-geolocate").on("click",function(){_geolocate()}),$("#activmap-target").length&&$("#activmap-target").on("click",function(){_update_map()}),$("#activmap-location").length){if(null!==s.country)var a={types:s.locationTypes,componentRestrictions:{country:s.country}};else a={types:s.locationTypes};var t=document.getElementById("activmap-location");autocomplete=new google.maps.places.Autocomplete(t,a),google.maps.event.addListener(autocomplete,"place_changed",function(){var e=autocomplete.getPlace();e.geometry.viewport?map.fitBounds(e.geometry.viewport):(latlng=e.geometry.location,map.setCenter(e.geometry.location),map.setZoom(s.zoom),$(".activmap-place").length&&_order(),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this))}),_update_map())})}$('input[name="activmap_radius"]').on("change",function(){s.radius=$(this).val(),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this))}),_update_map()}),$('input[name="marker_type[]"], select[name="marker_type[]"]').on("change",function(){_update_places_tag($(this)),_update_map()}),$("#activmap-reset").on("click",function(){return $('input[name="marker_type[]"], select[name="marker_type[]"]').prop("checked",!0),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this))}),latlng=init_latlng,map.setCenter(latlng),map.setZoom(s.zoom),_update_map(),!1}),$(document).on("click",".activmap-place",function(){var e=$(this).attr("id").replace("activmap-place_","");google.maps.event.trigger(markers[e],"click")}),$(window).on("resize",function(){_update_map()}),$('input[name="marker_type[]"]:checked').add($('select[name="marker_type[]"]').prop("selected",!0)).each(function(){_update_places_tag($(this))}),_update_map()},_rad=function(e){return e*Math.PI/180},_get_distance=function(e,a){var t=_rad(a.lat()-e.lat()),s=_rad(a.lng()-e.lng()),n=Math.sin(t/2)*Math.sin(t/2)+Math.cos(_rad(e.lat()))*Math.cos(_rad(a.lat()))*Math.sin(s/2)*Math.sin(s/2);return 6378137*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},_update_map=function(){map_w=$("#activmap-wrapper").width(),0<num_places?0==old_results?s.showPanel?("left"==s.posPanel&&activmap_places.stop(!0,!0).animate({left:0},600),"right"==s.posPanel&&activmap_places.stop(!0,!0).animate({right:0},600),activmap_places.is(":visible")?activmap_canvas.animate({width:map_w-cont_w},600,function(){map.fitBounds(bounds),s.cluster&&markerCluster.repaint()}):(map.fitBounds(bounds),s.cluster&&markerCluster.repaint())):(map.fitBounds(bounds),s.cluster&&markerCluster.repaint()):(s.showPanel&&activmap_places.is(":visible")?activmap_canvas.width(map_w-cont_w):activmap_canvas.width(map_w),map.fitBounds(bounds),s.cluster&&markerCluster.repaint()):(null!=opendInfoWindow&&opendInfoWindow.close(),s.showPanel&&activmap_places.is(":visible")?(activmap_canvas.animate({width:map_w},600),"left"==s.posPanel&&activmap_places.animate({left:-cont_w},600),"right"==s.posPanel&&activmap_places.animate({right:-cont_w},600)):activmap_canvas.width(map_w),s.cluster&&markerCluster.repaint(),map.setZoom(s.zoom),map.setCenter(latlng));var e=google.maps.event.addListener(map,"idle",function(){16<map.getZoom()&&map.setZoom(16),google.maps.event.removeListener(e)});old_results=num_places},_update_places_tag=function(e){var a,t=0,n=[],o=[];$('input[name="marker_type[]"]:checked').add($('select[name="marker_type[]"]').prop("selected",!0)).each(function(){""!=(a=$(this).val())&&(void 0===ids[a]&&(ids[a]=[]),0==t?n=$.merge([],ids[a]):("strict"==s.request&&(n=$.arrayIntersect(ids[a],n)),"large"==s.request&&(o=$.merge([],ids[a]),n=$.merge(o,n))),t++)}),$.each(s.places,function(e,a){a.num_tags=0,(a.dist=0)<=$.inArray(a.id,n)?(a.dist=_get_distance(a.marker.position,latlng),0==s.radius||a.dist<=1e3*s.radius?(a.num_tags++,a.marker.setVisible(!0),a.isVisible=!0,$("#activmap-place_"+a.id).show()):(0<a.num_tags&&a.num_tags--,0==a.num_tags&&(a.marker.setVisible(!1),a.isVisible=!1,$("#activmap-place_"+a.id).hide()))):(0<a.num_tags&&a.num_tags--,0==a.num_tags&&(a.marker.setVisible(!1),a.isVisible=!1,$("#activmap-place_"+a.id).hide()))}),bounds=new google.maps.LatLngBounds;t=0;$.each(s.places,function(e,a){1==a.isVisible&&(bounds.extend(a.marker.getPosition()),t++)}),num_places=t,$("#activmap-results-num").html(t+" result(s)")},Array.isArray(s.places)?_init():$.ajax({url:s.places,dataType:"json",cache:!1,error:function(e,a,t){console.log(e),console.log(a),console.log(t)},success:function(data){var obj=eval(data);s.places=obj.places,_init()}})}})}(jQuery);